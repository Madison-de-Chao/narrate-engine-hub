import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import type { SupabaseClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// 天干地支資料
const TIANGAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"];
const DIZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];

// 納音五行表（繁體中文）
const NAYIN: { [key: string]: string } = {
  "甲子": "海中金", "乙丑": "海中金",
  "丙寅": "爐中火", "丁卯": "爐中火",
  "戊辰": "大林木", "己巳": "大林木",
  "庚午": "路旁土", "辛未": "路旁土",
  "壬申": "劍鋒金", "癸酉": "劍鋒金",
  "甲戌": "山頭火", "乙亥": "山頭火",
  "丙子": "澗下水", "丁丑": "澗下水",
  "戊寅": "城頭土", "己卯": "城頭土",
  "庚辰": "白蠟金", "辛巳": "白蠟金",
  "壬午": "楊柳木", "癸未": "楊柳木",
  "甲申": "泉中水", "乙酉": "泉中水",
  "丙戌": "屋上土", "丁亥": "屋上土",
  "戊子": "霹靂火", "己丑": "霹靂火",
  "庚寅": "松柏木", "辛卯": "松柏木",
  "壬辰": "長流水", "癸巳": "長流水",
  "甲午": "沙中金", "乙未": "沙中金",
  "丙申": "山下火", "丁酉": "山下火",
  "戊戌": "平地木", "己亥": "平地木",
  "庚子": "壁上土", "辛丑": "壁上土",
  "壬寅": "金箔金", "癸卯": "金箔金",
  "甲辰": "覆燈火", "乙巳": "覆燈火",
  "丙午": "天河水", "丁未": "天河水",
  "戊申": "大驛土", "己酉": "大驛土",
  "庚戌": "釵釧金", "辛亥": "釵釧金",
  "壬子": "桑柘木", "癸丑": "桑柘木",
  "甲寅": "大溪水", "乙卯": "大溪水",
  "丙辰": "沙中土", "丁巳": "沙中土",
  "戊午": "天上火", "己未": "天上火",
  "庚申": "石榴木", "辛酉": "石榴木",
  "壬戌": "大海水", "癸亥": "大海水"
};

// 五行對應
const WUXING_MAP: { [key: string]: string } = {
  "甲": "木", "乙": "木",
  "丙": "火", "丁": "火",
  "戊": "土", "己": "土",
  "庚": "金", "辛": "金",
  "壬": "水", "癸": "水",
  "寅": "木", "卯": "木",
  "巳": "火", "午": "火",
  "辰": "土", "戌": "土", "丑": "土", "未": "土",
  "申": "金", "酉": "金",
  "子": "水", "亥": "水"
};

// 計算年柱
function calculateYearPillar(year: number, lichunDate: Date, birthDate: Date): { stem: string, branch: string } {
  let adjustedYear = year;
  if (birthDate < lichunDate) {
    adjustedYear = year - 1;
  }
  
  const stemIndex = (adjustedYear - 4) % 10;
  const branchIndex = (adjustedYear - 4) % 12;
  
  return {
    stem: TIANGAN[stemIndex < 0 ? stemIndex + 10 : stemIndex],
    branch: DIZHI[branchIndex < 0 ? branchIndex + 12 : branchIndex]
  };
}

// 計算月柱（基於節氣的精確算法）
// 使用 24 節氣中的「節」作為月份分界：
// 立春→寅、驚蟄→卯、清明→辰、立夏→巳、芒種→午、小暑→未、立秋→申、白露→酉、寒露→戌、立冬→亥、大雪→子、小寒→丑
// 並配合五虎遁月推算月干

// 對應表（節氣 → 地支索引） 0=子,1=丑,2=寅,...,11=亥
const SOLAR_TERM_BRANCH_ORDER = [
  { term: "立春", branchIndex: 2 },
  { term: "驚蟄", branchIndex: 3 },
  { term: "清明", branchIndex: 4 },
  { term: "立夏", branchIndex: 5 },
  { term: "芒種", branchIndex: 6 },
  { term: "小暑", branchIndex: 7 },
  { term: "立秋", branchIndex: 8 },
  { term: "白露", branchIndex: 9 },
  { term: "寒露", branchIndex: 10 },
  { term: "立冬", branchIndex: 11 },
  { term: "大雪", branchIndex: 0 },
  { term: "小寒", branchIndex: 1 },
] as const;

const SOLAR_TERM_BRANCH_MAP: Record<string, number> = SOLAR_TERM_BRANCH_ORDER.reduce(
  (acc, { term, branchIndex }) => {
    acc[term] = branchIndex;
    return acc;
  },
  {} as Record<string, number>
);

type SolarTermsYearData = Record<string, { date: string }>;

// 香港天文台節氣資料庫 (1901-2010) - 關鍵節氣（月份分界）
// 格式：直接使用日期字符串，時間為當地時間 00:00
const HKO_KEY_SOLAR_TERMS: Record<string, Record<string, string>> = {
  "1901": { "小寒": "1901-01-06", "立春": "1901-02-04", "驚蟄": "1901-03-06", "清明": "1901-04-05", "立夏": "1901-05-06", "芒種": "1901-06-06", "小暑": "1901-07-08", "立秋": "1901-08-08", "白露": "1901-09-08", "寒露": "1901-10-09", "立冬": "1901-11-08", "大雪": "1901-12-08" },
  "1902": { "小寒": "1902-01-06", "立春": "1902-02-05", "驚蟄": "1902-03-06", "清明": "1902-04-06", "立夏": "1902-05-06", "芒種": "1902-06-07", "小暑": "1902-07-08", "立秋": "1902-08-08", "白露": "1902-09-08", "寒露": "1902-10-09", "立冬": "1902-11-08", "大雪": "1902-12-08" },
  "1903": { "小寒": "1903-01-06", "立春": "1903-02-05", "驚蟄": "1903-03-07", "清明": "1903-04-06", "立夏": "1903-05-07", "芒種": "1903-06-07", "小暑": "1903-07-08", "立秋": "1903-08-09", "白露": "1903-09-09", "寒露": "1903-10-09", "立冬": "1903-11-08", "大雪": "1903-12-08" },
  "1904": { "小寒": "1904-01-07", "立春": "1904-02-05", "驚蟄": "1904-03-06", "清明": "1904-04-05", "立夏": "1904-05-06", "芒種": "1904-06-06", "小暑": "1904-07-07", "立秋": "1904-08-08", "白露": "1904-09-08", "寒露": "1904-10-09", "立冬": "1904-11-08", "大雪": "1904-12-07" },
  "1905": { "小寒": "1905-01-06", "立春": "1905-02-04", "驚蟄": "1905-03-06", "清明": "1905-04-05", "立夏": "1905-05-06", "芒種": "1905-06-06", "小暑": "1905-07-08", "立秋": "1905-08-08", "白露": "1905-09-08", "寒露": "1905-10-09", "立冬": "1905-11-08", "大雪": "1905-12-08" },
  "1906": { "小寒": "1906-01-06", "立春": "1906-02-05", "驚蟄": "1906-03-06", "清明": "1906-04-06", "立夏": "1906-05-06", "芒種": "1906-06-06", "小暑": "1906-07-08", "立秋": "1906-08-08", "白露": "1906-09-08", "寒露": "1906-10-09", "立冬": "1906-11-08", "大雪": "1906-12-08" },
  "1907": { "小寒": "1907-01-06", "立春": "1907-02-05", "驚蟄": "1907-03-06", "清明": "1907-04-06", "立夏": "1907-05-07", "芒種": "1907-06-07", "小暑": "1907-07-08", "立秋": "1907-08-08", "白露": "1907-09-09", "寒露": "1907-10-09", "立冬": "1907-11-08", "大雪": "1907-12-08" },
  "1908": { "小寒": "1908-01-07", "立春": "1908-02-05", "驚蟄": "1908-03-06", "清明": "1908-04-05", "立夏": "1908-05-06", "芒種": "1908-06-06", "小暑": "1908-07-07", "立秋": "1908-08-08", "白露": "1908-09-08", "寒露": "1908-10-08", "立冬": "1908-11-08", "大雪": "1908-12-07" },
  "1909": { "小寒": "1909-01-06", "立春": "1909-02-04", "驚蟄": "1909-03-06", "清明": "1909-04-05", "立夏": "1909-05-06", "芒種": "1909-06-06", "小暑": "1909-07-08", "立秋": "1909-08-08", "白露": "1909-09-08", "寒露": "1909-10-09", "立冬": "1909-11-08", "大雪": "1909-12-08" },
  "1910": { "小寒": "1910-01-06", "立春": "1910-02-05", "驚蟄": "1910-03-06", "清明": "1910-04-06", "立夏": "1910-05-06", "芒種": "1910-06-06", "小暑": "1910-07-08", "立秋": "1910-08-08", "白露": "1910-09-08", "寒露": "1910-10-09", "立冬": "1910-11-08", "大雪": "1910-12-08" },
  "1911": { "小寒": "1911-01-06", "立春": "1911-02-05", "驚蟄": "1911-03-06", "清明": "1911-04-06", "立夏": "1911-05-07", "芒種": "1911-06-07", "小暑": "1911-07-08", "立秋": "1911-08-08", "白露": "1911-09-09", "寒露": "1911-10-09", "立冬": "1911-11-08", "大雪": "1911-12-08" },
  "1912": { "小寒": "1912-01-07", "立春": "1912-02-05", "驚蟄": "1912-03-06", "清明": "1912-04-05", "立夏": "1912-05-06", "芒種": "1912-06-06", "小暑": "1912-07-07", "立秋": "1912-08-08", "白露": "1912-09-08", "寒露": "1912-10-08", "立冬": "1912-11-08", "大雪": "1912-12-07" },
  "1913": { "小寒": "1913-01-06", "立春": "1913-02-04", "驚蟄": "1913-03-06", "清明": "1913-04-05", "立夏": "1913-05-06", "芒種": "1913-06-06", "小暑": "1913-07-07", "立秋": "1913-08-08", "白露": "1913-09-08", "寒露": "1913-10-09", "立冬": "1913-11-08", "大雪": "1913-12-08" },
  "1914": { "小寒": "1914-01-06", "立春": "1914-02-05", "驚蟄": "1914-03-06", "清明": "1914-04-06", "立夏": "1914-05-06", "芒種": "1914-06-06", "小暑": "1914-07-08", "立秋": "1914-08-08", "白露": "1914-09-08", "寒露": "1914-10-09", "立冬": "1914-11-08", "大雪": "1914-12-08" },
  "1915": { "小寒": "1915-01-06", "立春": "1915-02-05", "驚蟄": "1915-03-06", "清明": "1915-04-06", "立夏": "1915-05-06", "芒種": "1915-06-07", "小暑": "1915-07-08", "立秋": "1915-08-08", "白露": "1915-09-08", "寒露": "1915-10-09", "立冬": "1915-11-08", "大雪": "1915-12-08" },
  "1916": { "小寒": "1916-01-07", "立春": "1916-02-05", "驚蟄": "1916-03-06", "清明": "1916-04-05", "立夏": "1916-05-06", "芒種": "1916-06-06", "小暑": "1916-07-07", "立秋": "1916-08-08", "白露": "1916-09-08", "寒露": "1916-10-08", "立冬": "1916-11-08", "大雪": "1916-12-07" },
  "1917": { "小寒": "1917-01-06", "立春": "1917-02-04", "驚蟄": "1917-03-06", "清明": "1917-04-05", "立夏": "1917-05-06", "芒種": "1917-06-06", "小暑": "1917-07-07", "立秋": "1917-08-08", "白露": "1917-09-08", "寒露": "1917-10-09", "立冬": "1917-11-08", "大雪": "1917-12-08" },
  "1918": { "小寒": "1918-01-06", "立春": "1918-02-04", "驚蟄": "1918-03-06", "清明": "1918-04-05", "立夏": "1918-05-06", "芒種": "1918-06-06", "小暑": "1918-07-08", "立秋": "1918-08-08", "白露": "1918-09-08", "寒露": "1918-10-09", "立冬": "1918-11-08", "大雪": "1918-12-08" },
  "1919": { "小寒": "1919-01-06", "立春": "1919-02-05", "驚蟄": "1919-03-06", "清明": "1919-04-06", "立夏": "1919-05-06", "芒種": "1919-06-07", "小暑": "1919-07-08", "立秋": "1919-08-08", "白露": "1919-09-08", "寒露": "1919-10-09", "立冬": "1919-11-08", "大雪": "1919-12-08" },
  "1920": { "小寒": "1920-01-06", "立春": "1920-02-05", "驚蟄": "1920-03-06", "清明": "1920-04-05", "立夏": "1920-05-06", "芒種": "1920-06-06", "小暑": "1920-07-07", "立秋": "1920-08-08", "白露": "1920-09-08", "寒露": "1920-10-08", "立冬": "1920-11-08", "大雪": "1920-12-07" },
  "1921": { "小寒": "1921-01-06", "立春": "1921-02-04", "驚蟄": "1921-03-06", "清明": "1921-04-05", "立夏": "1921-05-06", "芒種": "1921-06-06", "小暑": "1921-07-07", "立秋": "1921-08-08", "白露": "1921-09-08", "寒露": "1921-10-09", "立冬": "1921-11-08", "大雪": "1921-12-08" },
  "1922": { "小寒": "1922-01-06", "立春": "1922-02-04", "驚蟄": "1922-03-06", "清明": "1922-04-05", "立夏": "1922-05-06", "芒種": "1922-06-06", "小暑": "1922-07-08", "立秋": "1922-08-08", "白露": "1922-09-08", "寒露": "1922-10-09", "立冬": "1922-11-08", "大雪": "1922-12-08" },
  "1923": { "小寒": "1923-01-06", "立春": "1923-02-05", "驚蟄": "1923-03-06", "清明": "1923-04-06", "立夏": "1923-05-06", "芒種": "1923-06-06", "小暑": "1923-07-08", "立秋": "1923-08-08", "白露": "1923-09-08", "寒露": "1923-10-09", "立冬": "1923-11-08", "大雪": "1923-12-08" },
  "1924": { "小寒": "1924-01-06", "立春": "1924-02-05", "驚蟄": "1924-03-06", "清明": "1924-04-05", "立夏": "1924-05-06", "芒種": "1924-06-06", "小暑": "1924-07-07", "立秋": "1924-08-08", "白露": "1924-09-08", "寒露": "1924-10-08", "立冬": "1924-11-08", "大雪": "1924-12-07" },
  "1925": { "小寒": "1925-01-06", "立春": "1925-02-04", "驚蟄": "1925-03-06", "清明": "1925-04-05", "立夏": "1925-05-06", "芒種": "1925-06-06", "小暑": "1925-07-07", "立秋": "1925-08-08", "白露": "1925-09-08", "寒露": "1925-10-08", "立冬": "1925-11-08", "大雪": "1925-12-08" },
  "1926": { "小寒": "1926-01-06", "立春": "1926-02-04", "驚蟄": "1926-03-06", "清明": "1926-04-05", "立夏": "1926-05-06", "芒種": "1926-06-06", "小暑": "1926-07-08", "立秋": "1926-08-08", "白露": "1926-09-08", "寒露": "1926-10-09", "立冬": "1926-11-08", "大雪": "1926-12-08" },
  "1927": { "小寒": "1927-01-06", "立春": "1927-02-05", "驚蟄": "1927-03-06", "清明": "1927-04-06", "立夏": "1927-05-06", "芒種": "1927-06-06", "小暑": "1927-07-08", "立秋": "1927-08-08", "白露": "1927-09-08", "寒露": "1927-10-09", "立冬": "1927-11-08", "大雪": "1927-12-08" },
  "1928": { "小寒": "1928-01-06", "立春": "1928-02-05", "驚蟄": "1928-03-06", "清明": "1928-04-05", "立夏": "1928-05-06", "芒種": "1928-06-06", "小暑": "1928-07-07", "立秋": "1928-08-08", "白露": "1928-09-08", "寒露": "1928-10-08", "立冬": "1928-11-08", "大雪": "1928-12-07" },
  "1929": { "小寒": "1929-01-06", "立春": "1929-02-04", "驚蟄": "1929-03-06", "清明": "1929-04-05", "立夏": "1929-05-06", "芒種": "1929-06-06", "小暑": "1929-07-07", "立秋": "1929-08-08", "白露": "1929-09-08", "寒露": "1929-10-08", "立冬": "1929-11-08", "大雪": "1929-12-08" },
  "1930": { "小寒": "1930-01-06", "立春": "1930-02-04", "驚蟄": "1930-03-06", "清明": "1930-04-05", "立夏": "1930-05-06", "芒種": "1930-06-06", "小暑": "1930-07-08", "立秋": "1930-08-08", "白露": "1930-09-08", "寒露": "1930-10-09", "立冬": "1930-11-08", "大雪": "1930-12-08" },
  "1931": { "小寒": "1931-01-06", "立春": "1931-02-05", "驚蟄": "1931-03-06", "清明": "1931-04-06", "立夏": "1931-05-06", "芒種": "1931-06-06", "小暑": "1931-07-08", "立秋": "1931-08-08", "白露": "1931-09-08", "寒露": "1931-10-09", "立冬": "1931-11-08", "大雪": "1931-12-08" },
  "1932": { "小寒": "1932-01-06", "立春": "1932-02-05", "驚蟄": "1932-03-06", "清明": "1932-04-05", "立夏": "1932-05-06", "芒種": "1932-06-06", "小暑": "1932-07-07", "立秋": "1932-08-08", "白露": "1932-09-08", "寒露": "1932-10-08", "立冬": "1932-11-07", "大雪": "1932-12-07" },
  "1933": { "小寒": "1933-01-06", "立春": "1933-02-04", "驚蟄": "1933-03-06", "清明": "1933-04-05", "立夏": "1933-05-06", "芒種": "1933-06-06", "小暑": "1933-07-07", "立秋": "1933-08-08", "白露": "1933-09-08", "寒露": "1933-10-08", "立冬": "1933-11-08", "大雪": "1933-12-07" },
  "1934": { "小寒": "1934-01-06", "立春": "1934-02-04", "驚蟄": "1934-03-06", "清明": "1934-04-05", "立夏": "1934-05-06", "芒種": "1934-06-06", "小暑": "1934-07-08", "立秋": "1934-08-08", "白露": "1934-09-08", "寒露": "1934-10-09", "立冬": "1934-11-08", "大雪": "1934-12-08" },
  "1935": { "小寒": "1935-01-06", "立春": "1935-02-04", "驚蟄": "1935-03-06", "清明": "1935-04-05", "立夏": "1935-05-06", "芒種": "1935-06-06", "小暑": "1935-07-08", "立秋": "1935-08-08", "白露": "1935-09-08", "寒露": "1935-10-09", "立冬": "1935-11-08", "大雪": "1935-12-08" },
  "1936": { "小寒": "1936-01-06", "立春": "1936-02-05", "驚蟄": "1936-03-06", "清明": "1936-04-05", "立夏": "1936-05-06", "芒種": "1936-06-06", "小暑": "1936-07-07", "立秋": "1936-08-08", "白露": "1936-09-08", "寒露": "1936-10-08", "立冬": "1936-11-07", "大雪": "1936-12-07" },
  "1937": { "小寒": "1937-01-06", "立春": "1937-02-04", "驚蟄": "1937-03-06", "清明": "1937-04-05", "立夏": "1937-05-06", "芒種": "1937-06-06", "小暑": "1937-07-07", "立秋": "1937-08-08", "白露": "1937-09-08", "寒露": "1937-10-08", "立冬": "1937-11-08", "大雪": "1937-12-07" },
  "1938": { "小寒": "1938-01-06", "立春": "1938-02-04", "驚蟄": "1938-03-06", "清明": "1938-04-05", "立夏": "1938-05-06", "芒種": "1938-06-06", "小暑": "1938-07-08", "立秋": "1938-08-08", "白露": "1938-09-08", "寒露": "1938-10-09", "立冬": "1938-11-08", "大雪": "1938-12-08" },
  "1939": { "小寒": "1939-01-06", "立春": "1939-02-04", "驚蟄": "1939-03-06", "清明": "1939-04-05", "立夏": "1939-05-06", "芒種": "1939-06-06", "小暑": "1939-07-08", "立秋": "1939-08-08", "白露": "1939-09-08", "寒露": "1939-10-09", "立冬": "1939-11-08", "大雪": "1939-12-08" },
  "1940": { "小寒": "1940-01-06", "立春": "1940-02-05", "驚蟄": "1940-03-06", "清明": "1940-04-05", "立夏": "1940-05-06", "芒種": "1940-06-06", "小暑": "1940-07-07", "立秋": "1940-08-08", "白露": "1940-09-08", "寒露": "1940-10-08", "立冬": "1940-11-07", "大雪": "1940-12-07" },
  "1941": { "小寒": "1941-01-06", "立春": "1941-02-04", "驚蟄": "1941-03-06", "清明": "1941-04-05", "立夏": "1941-05-06", "芒種": "1941-06-06", "小暑": "1941-07-07", "立秋": "1941-08-08", "白露": "1941-09-08", "寒露": "1941-10-08", "立冬": "1941-11-08", "大雪": "1941-12-07" },
  "1942": { "小寒": "1942-01-06", "立春": "1942-02-04", "驚蟄": "1942-03-06", "清明": "1942-04-05", "立夏": "1942-05-06", "芒種": "1942-06-06", "小暑": "1942-07-08", "立秋": "1942-08-08", "白露": "1942-09-08", "寒露": "1942-10-09", "立冬": "1942-11-08", "大雪": "1942-12-08" },
  "1943": { "小寒": "1943-01-06", "立春": "1943-02-04", "驚蟄": "1943-03-06", "清明": "1943-04-05", "立夏": "1943-05-06", "芒種": "1943-06-06", "小暑": "1943-07-08", "立秋": "1943-08-08", "白露": "1943-09-08", "寒露": "1943-10-09", "立冬": "1943-11-08", "大雪": "1943-12-08" },
  "1944": { "小寒": "1944-01-06", "立春": "1944-02-05", "驚蟄": "1944-03-06", "清明": "1944-04-05", "立夏": "1944-05-06", "芒種": "1944-06-06", "小暑": "1944-07-07", "立秋": "1944-08-07", "白露": "1944-09-08", "寒露": "1944-10-08", "立冬": "1944-11-07", "大雪": "1944-12-07" },
  "1945": { "小寒": "1945-01-06", "立春": "1945-02-04", "驚蟄": "1945-03-06", "清明": "1945-04-05", "立夏": "1945-05-06", "芒種": "1945-06-06", "小暑": "1945-07-07", "立秋": "1945-08-08", "白露": "1945-09-08", "寒露": "1945-10-08", "立冬": "1945-11-07", "大雪": "1945-12-07" },
  "1946": { "小寒": "1946-01-06", "立春": "1946-02-04", "驚蟄": "1946-03-06", "清明": "1946-04-05", "立夏": "1946-05-06", "芒種": "1946-06-06", "小暑": "1946-07-08", "立秋": "1946-08-08", "白露": "1946-09-08", "寒露": "1946-10-08", "立冬": "1946-11-08", "大雪": "1946-12-07" },
  "1947": { "小寒": "1947-01-06", "立春": "1947-02-04", "驚蟄": "1947-03-06", "清明": "1947-04-05", "立夏": "1947-05-06", "芒種": "1947-06-06", "小暑": "1947-07-08", "立秋": "1947-08-08", "白露": "1947-09-08", "寒露": "1947-10-09", "立冬": "1947-11-08", "大雪": "1947-12-08" },
  "1948": { "小寒": "1948-01-06", "立春": "1948-02-05", "驚蟄": "1948-03-05", "清明": "1948-04-05", "立夏": "1948-05-05", "芒種": "1948-06-05", "小暑": "1948-07-07", "立秋": "1948-08-07", "白露": "1948-09-07", "寒露": "1948-10-08", "立冬": "1948-11-07", "大雪": "1948-12-07" },
  "1949": { "小寒": "1949-01-05", "立春": "1949-02-04", "驚蟄": "1949-03-06", "清明": "1949-04-05", "立夏": "1949-05-06", "芒種": "1949-06-06", "小暑": "1949-07-07", "立秋": "1949-08-08", "白露": "1949-09-08", "寒露": "1949-10-08", "立冬": "1949-11-07", "大雪": "1949-12-07" },
  "1950": { "小寒": "1950-01-06", "立春": "1950-02-04", "驚蟄": "1950-03-06", "清明": "1950-04-05", "立夏": "1950-05-06", "芒種": "1950-06-06", "小暑": "1950-07-07", "立秋": "1950-08-08", "白露": "1950-09-08", "寒露": "1950-10-08", "立冬": "1950-11-08", "大雪": "1950-12-07" },
  "1951": { "小寒": "1951-01-06", "立春": "1951-02-04", "驚蟄": "1951-03-06", "清明": "1951-04-05", "立夏": "1951-05-06", "芒種": "1951-06-06", "小暑": "1951-07-08", "立秋": "1951-08-08", "白露": "1951-09-08", "寒露": "1951-10-09", "立冬": "1951-11-08", "大雪": "1951-12-08" },
  "1952": { "小寒": "1952-01-06", "立春": "1952-02-05", "驚蟄": "1952-03-05", "清明": "1952-04-05", "立夏": "1952-05-05", "芒種": "1952-06-05", "小暑": "1952-07-07", "立秋": "1952-08-07", "白露": "1952-09-07", "寒露": "1952-10-08", "立冬": "1952-11-07", "大雪": "1952-12-07" },
  "1953": { "小寒": "1953-01-05", "立春": "1953-02-04", "驚蟄": "1953-03-05", "清明": "1953-04-05", "立夏": "1953-05-06", "芒種": "1953-06-06", "小暑": "1953-07-07", "立秋": "1953-08-07", "白露": "1953-09-08", "寒露": "1953-10-08", "立冬": "1953-11-07", "大雪": "1953-12-07" },
  "1954": { "小寒": "1954-01-06", "立春": "1954-02-04", "驚蟄": "1954-03-06", "清明": "1954-04-05", "立夏": "1954-05-06", "芒種": "1954-06-06", "小暑": "1954-07-07", "立秋": "1954-08-08", "白露": "1954-09-08", "寒露": "1954-10-08", "立冬": "1954-11-08", "大雪": "1954-12-07" },
  "1955": { "小寒": "1955-01-06", "立春": "1955-02-04", "驚蟄": "1955-03-06", "清明": "1955-04-05", "立夏": "1955-05-06", "芒種": "1955-06-06", "小暑": "1955-07-08", "立秋": "1955-08-08", "白露": "1955-09-08", "寒露": "1955-10-09", "立冬": "1955-11-08", "大雪": "1955-12-08" },
  "1956": { "小寒": "1956-01-06", "立春": "1956-02-05", "驚蟄": "1956-03-05", "清明": "1956-04-05", "立夏": "1956-05-05", "芒種": "1956-06-05", "小暑": "1956-07-07", "立秋": "1956-08-07", "白露": "1956-09-07", "寒露": "1956-10-08", "立冬": "1956-11-07", "大雪": "1956-12-07" },
  "1957": { "小寒": "1957-01-05", "立春": "1957-02-04", "驚蟄": "1957-03-05", "清明": "1957-04-05", "立夏": "1957-05-06", "芒種": "1957-06-06", "小暑": "1957-07-07", "立秋": "1957-08-07", "白露": "1957-09-08", "寒露": "1957-10-08", "立冬": "1957-11-07", "大雪": "1957-12-07" },
  "1958": { "小寒": "1958-01-06", "立春": "1958-02-04", "驚蟄": "1958-03-06", "清明": "1958-04-05", "立夏": "1958-05-06", "芒種": "1958-06-06", "小暑": "1958-07-07", "立秋": "1958-08-08", "白露": "1958-09-08", "寒露": "1958-10-08", "立冬": "1958-11-08", "大雪": "1958-12-07" },
  "1959": { "小寒": "1959-01-06", "立春": "1959-02-04", "驚蟄": "1959-03-06", "清明": "1959-04-05", "立夏": "1959-05-06", "芒種": "1959-06-06", "小暑": "1959-07-08", "立秋": "1959-08-08", "白露": "1959-09-08", "寒露": "1959-10-09", "立冬": "1959-11-08", "大雪": "1959-12-08" },
  "1960": { "小寒": "1960-01-06", "立春": "1960-02-05", "驚蟄": "1960-03-05", "清明": "1960-04-05", "立夏": "1960-05-05", "芒種": "1960-06-05", "小暑": "1960-07-07", "立秋": "1960-08-07", "白露": "1960-09-07", "寒露": "1960-10-08", "立冬": "1960-11-07", "大雪": "1960-12-07" },
  "1961": { "小寒": "1961-01-05", "立春": "1961-02-04", "驚蟄": "1961-03-05", "清明": "1961-04-05", "立夏": "1961-05-05", "芒種": "1961-06-06", "小暑": "1961-07-07", "立秋": "1961-08-07", "白露": "1961-09-08", "寒露": "1961-10-08", "立冬": "1961-11-07", "大雪": "1961-12-07" },
  "1962": { "小寒": "1962-01-06", "立春": "1962-02-04", "驚蟄": "1962-03-06", "清明": "1962-04-05", "立夏": "1962-05-06", "芒種": "1962-06-06", "小暑": "1962-07-07", "立秋": "1962-08-08", "白露": "1962-09-08", "寒露": "1962-10-08", "立冬": "1962-11-08", "大雪": "1962-12-07" },
  "1963": { "小寒": "1963-01-06", "立春": "1963-02-04", "驚蟄": "1963-03-06", "清明": "1963-04-05", "立夏": "1963-05-06", "芒種": "1963-06-06", "小暑": "1963-07-08", "立秋": "1963-08-08", "白露": "1963-09-08", "寒露": "1963-10-09", "立冬": "1963-11-08", "大雪": "1963-12-08" },
  "1964": { "小寒": "1964-01-06", "立春": "1964-02-05", "驚蟄": "1964-03-05", "清明": "1964-04-05", "立夏": "1964-05-05", "芒種": "1964-06-05", "小暑": "1964-07-07", "立秋": "1964-08-07", "白露": "1964-09-07", "寒露": "1964-10-08", "立冬": "1964-11-07", "大雪": "1964-12-07" },
  "1965": { "小寒": "1965-01-05", "立春": "1965-02-04", "驚蟄": "1965-03-05", "清明": "1965-04-05", "立夏": "1965-05-05", "芒種": "1965-06-06", "小暑": "1965-07-07", "立秋": "1965-08-07", "白露": "1965-09-08", "寒露": "1965-10-08", "立冬": "1965-11-07", "大雪": "1965-12-07" },
  "1966": { "小寒": "1966-01-06", "立春": "1966-02-04", "驚蟄": "1966-03-06", "清明": "1966-04-05", "立夏": "1966-05-06", "芒種": "1966-06-06", "小暑": "1966-07-07", "立秋": "1966-08-08", "白露": "1966-09-08", "寒露": "1966-10-08", "立冬": "1966-11-08", "大雪": "1966-12-07" },
  "1967": { "小寒": "1967-01-06", "立春": "1967-02-04", "驚蟄": "1967-03-06", "清明": "1967-04-05", "立夏": "1967-05-06", "芒種": "1967-06-06", "小暑": "1967-07-07", "立秋": "1967-08-08", "白露": "1967-09-08", "寒露": "1967-10-08", "立冬": "1967-11-08", "大雪": "1967-12-07" },
  "1968": { "小寒": "1968-01-06", "立春": "1968-02-05", "驚蟄": "1968-03-05", "清明": "1968-04-04", "立夏": "1968-05-05", "芒種": "1968-06-05", "小暑": "1968-07-07", "立秋": "1968-08-07", "白露": "1968-09-07", "寒露": "1968-10-08", "立冬": "1968-11-07", "大雪": "1968-12-07" },
  "1969": { "小寒": "1969-01-05", "立春": "1969-02-04", "驚蟄": "1969-03-05", "清明": "1969-04-05", "立夏": "1969-05-05", "芒種": "1969-06-06", "小暑": "1969-07-07", "立秋": "1969-08-07", "白露": "1969-09-08", "寒露": "1969-10-08", "立冬": "1969-11-07", "大雪": "1969-12-07" },
  "1970": { "小寒": "1970-01-06", "立春": "1970-02-04", "驚蟄": "1970-03-06", "清明": "1970-04-05", "立夏": "1970-05-06", "芒種": "1970-06-06", "小暑": "1970-07-07", "立秋": "1970-08-08", "白露": "1970-09-08", "寒露": "1970-10-08", "立冬": "1970-11-08", "大雪": "1970-12-07" },
  "1971": { "小寒": "1971-01-06", "立春": "1971-02-04", "驚蟄": "1971-03-06", "清明": "1971-04-05", "立夏": "1971-05-06", "芒種": "1971-06-06", "小暑": "1971-07-07", "立秋": "1971-08-08", "白露": "1971-09-08", "寒露": "1971-10-08", "立冬": "1971-11-08", "大雪": "1971-12-07" },
  "1972": { "小寒": "1972-01-06", "立春": "1972-02-05", "驚蟄": "1972-03-05", "清明": "1972-04-04", "立夏": "1972-05-05", "芒種": "1972-06-05", "小暑": "1972-07-07", "立秋": "1972-08-07", "白露": "1972-09-07", "寒露": "1972-10-08", "立冬": "1972-11-07", "大雪": "1972-12-07" },
  "1973": { "小寒": "1973-01-05", "立春": "1973-02-04", "驚蟄": "1973-03-05", "清明": "1973-04-05", "立夏": "1973-05-05", "芒種": "1973-06-06", "小暑": "1973-07-07", "立秋": "1973-08-07", "白露": "1973-09-08", "寒露": "1973-10-08", "立冬": "1973-11-07", "大雪": "1973-12-07" },
  "1974": { "小寒": "1974-01-06", "立春": "1974-02-04", "驚蟄": "1974-03-06", "清明": "1974-04-05", "立夏": "1974-05-06", "芒種": "1974-06-06", "小暑": "1974-07-07", "立秋": "1974-08-08", "白露": "1974-09-08", "寒露": "1974-10-08", "立冬": "1974-11-08", "大雪": "1974-12-07" },
  "1975": { "小寒": "1975-01-06", "立春": "1975-02-04", "驚蟄": "1975-03-06", "清明": "1975-04-05", "立夏": "1975-05-06", "芒種": "1975-06-06", "小暑": "1975-07-07", "立秋": "1975-08-08", "白露": "1975-09-08", "寒露": "1975-10-08", "立冬": "1975-11-08", "大雪": "1975-12-07" },
  "1976": { "小寒": "1976-01-06", "立春": "1976-02-05", "驚蟄": "1976-03-05", "清明": "1976-04-04", "立夏": "1976-05-05", "芒種": "1976-06-05", "小暑": "1976-07-07", "立秋": "1976-08-07", "白露": "1976-09-07", "寒露": "1976-10-08", "立冬": "1976-11-07", "大雪": "1976-12-07" },
  "1977": { "小寒": "1977-01-05", "立春": "1977-02-04", "驚蟄": "1977-03-05", "清明": "1977-04-05", "立夏": "1977-05-05", "芒種": "1977-06-06", "小暑": "1977-07-07", "立秋": "1977-08-07", "白露": "1977-09-08", "寒露": "1977-10-08", "立冬": "1977-11-07", "大雪": "1977-12-07" },
  "1978": { "小寒": "1978-01-06", "立春": "1978-02-04", "驚蟄": "1978-03-06", "清明": "1978-04-05", "立夏": "1978-05-06", "芒種": "1978-06-06", "小暑": "1978-07-07", "立秋": "1978-08-08", "白露": "1978-09-08", "寒露": "1978-10-08", "立冬": "1978-11-08", "大雪": "1978-12-07" },
  "1979": { "小寒": "1979-01-06", "立春": "1979-02-04", "驚蟄": "1979-03-06", "清明": "1979-04-05", "立夏": "1979-05-06", "芒種": "1979-06-06", "小暑": "1979-07-07", "立秋": "1979-08-08", "白露": "1979-09-08", "寒露": "1979-10-08", "立冬": "1979-11-08", "大雪": "1979-12-07" },
  "1980": { "小寒": "1980-01-06", "立春": "1980-02-05", "驚蟄": "1980-03-05", "清明": "1980-04-04", "立夏": "1980-05-05", "芒種": "1980-06-05", "小暑": "1980-07-07", "立秋": "1980-08-07", "白露": "1980-09-07", "寒露": "1980-10-08", "立冬": "1980-11-07", "大雪": "1980-12-07" },
  "1981": { "小寒": "1981-01-05", "立春": "1981-02-04", "驚蟄": "1981-03-05", "清明": "1981-04-05", "立夏": "1981-05-05", "芒種": "1981-06-06", "小暑": "1981-07-07", "立秋": "1981-08-07", "白露": "1981-09-08", "寒露": "1981-10-08", "立冬": "1981-11-07", "大雪": "1981-12-07" },
  "1982": { "小寒": "1982-01-06", "立春": "1982-02-04", "驚蟄": "1982-03-06", "清明": "1982-04-05", "立夏": "1982-05-06", "芒種": "1982-06-06", "小暑": "1982-07-07", "立秋": "1982-08-08", "白露": "1982-09-08", "寒露": "1982-10-08", "立冬": "1982-11-08", "大雪": "1982-12-07" },
  "1983": { "小寒": "1983-01-06", "立春": "1983-02-04", "驚蟄": "1983-03-06", "清明": "1983-04-05", "立夏": "1983-05-06", "芒種": "1983-06-06", "小暑": "1983-07-07", "立秋": "1983-08-08", "白露": "1983-09-08", "寒露": "1983-10-08", "立冬": "1983-11-08", "大雪": "1983-12-07" },
  "1984": { "小寒": "1984-01-06", "立春": "1984-02-04", "驚蟄": "1984-03-05", "清明": "1984-04-04", "立夏": "1984-05-05", "芒種": "1984-06-05", "小暑": "1984-07-07", "立秋": "1984-08-07", "白露": "1984-09-07", "寒露": "1984-10-08", "立冬": "1984-11-07", "大雪": "1984-12-07" },
  "1985": { "小寒": "1985-01-05", "立春": "1985-02-04", "驚蟄": "1985-03-05", "清明": "1985-04-05", "立夏": "1985-05-05", "芒種": "1985-06-06", "小暑": "1985-07-07", "立秋": "1985-08-07", "白露": "1985-09-08", "寒露": "1985-10-08", "立冬": "1985-11-07", "大雪": "1985-12-07" },
  "1986": { "小寒": "1986-01-06", "立春": "1986-02-04", "驚蟄": "1986-03-06", "清明": "1986-04-05", "立夏": "1986-05-06", "芒種": "1986-06-06", "小暑": "1986-07-07", "立秋": "1986-08-08", "白露": "1986-09-08", "寒露": "1986-10-08", "立冬": "1986-11-08", "大雪": "1986-12-07" },
  "1987": { "小寒": "1987-01-06", "立春": "1987-02-04", "驚蟄": "1987-03-06", "清明": "1987-04-05", "立夏": "1987-05-06", "芒種": "1987-06-06", "小暑": "1987-07-07", "立秋": "1987-08-08", "白露": "1987-09-08", "寒露": "1987-10-08", "立冬": "1987-11-08", "大雪": "1987-12-07" },
  "1988": { "小寒": "1988-01-06", "立春": "1988-02-04", "驚蟄": "1988-03-05", "清明": "1988-04-04", "立夏": "1988-05-05", "芒種": "1988-06-05", "小暑": "1988-07-07", "立秋": "1988-08-07", "白露": "1988-09-07", "寒露": "1988-10-08", "立冬": "1988-11-07", "大雪": "1988-12-07" },
  "1989": { "小寒": "1989-01-05", "立春": "1989-02-04", "驚蟄": "1989-03-05", "清明": "1989-04-05", "立夏": "1989-05-05", "芒種": "1989-06-06", "小暑": "1989-07-07", "立秋": "1989-08-07", "白露": "1989-09-07", "寒露": "1989-10-08", "立冬": "1989-11-07", "大雪": "1989-12-07" },
  "1990": { "小寒": "1990-01-05", "立春": "1990-02-04", "驚蟄": "1990-03-06", "清明": "1990-04-05", "立夏": "1990-05-05", "芒種": "1990-06-06", "小暑": "1990-07-07", "立秋": "1990-08-07", "白露": "1990-09-08", "寒露": "1990-10-08", "立冬": "1990-11-07", "大雪": "1990-12-07" },
  "1991": { "小寒": "1991-01-06", "立春": "1991-02-04", "驚蟄": "1991-03-06", "清明": "1991-04-05", "立夏": "1991-05-06", "芒種": "1991-06-06", "小暑": "1991-07-07", "立秋": "1991-08-08", "白露": "1991-09-08", "寒露": "1991-10-08", "立冬": "1991-11-08", "大雪": "1991-12-07" },
  "1992": { "小寒": "1992-01-06", "立春": "1992-02-04", "驚蟄": "1992-03-05", "清明": "1992-04-04", "立夏": "1992-05-05", "芒種": "1992-06-05", "小暑": "1992-07-07", "立秋": "1992-08-07", "白露": "1992-09-07", "寒露": "1992-10-08", "立冬": "1992-11-07", "大雪": "1992-12-07" },
  "1993": { "小寒": "1993-01-05", "立春": "1993-02-04", "驚蟄": "1993-03-05", "清明": "1993-04-05", "立夏": "1993-05-05", "芒種": "1993-06-06", "小暑": "1993-07-07", "立秋": "1993-08-07", "白露": "1993-09-07", "寒露": "1993-10-08", "立冬": "1993-11-07", "大雪": "1993-12-07" },
  "1994": { "小寒": "1994-01-05", "立春": "1994-02-04", "驚蟄": "1994-03-06", "清明": "1994-04-05", "立夏": "1994-05-06", "芒種": "1994-06-06", "小暑": "1994-07-07", "立秋": "1994-08-08", "白露": "1994-09-08", "寒露": "1994-10-08", "立冬": "1994-11-07", "大雪": "1994-12-07" },
  "1995": { "小寒": "1995-01-06", "立春": "1995-02-04", "驚蟄": "1995-03-06", "清明": "1995-04-05", "立夏": "1995-05-06", "芒種": "1995-06-06", "小暑": "1995-07-07", "立秋": "1995-08-08", "白露": "1995-09-08", "寒露": "1995-10-09", "立冬": "1995-11-08", "大雪": "1995-12-07" },
  "1996": { "小寒": "1996-01-06", "立春": "1996-02-04", "驚蟄": "1996-03-05", "清明": "1996-04-04", "立夏": "1996-05-05", "芒種": "1996-06-05", "小暑": "1996-07-07", "立秋": "1996-08-07", "白露": "1996-09-07", "寒露": "1996-10-08", "立冬": "1996-11-07", "大雪": "1996-12-07" },
  "1997": { "小寒": "1997-01-05", "立春": "1997-02-04", "驚蟄": "1997-03-05", "清明": "1997-04-05", "立夏": "1997-05-05", "芒種": "1997-06-05", "小暑": "1997-07-07", "立秋": "1997-08-07", "白露": "1997-09-07", "寒露": "1997-10-08", "立冬": "1997-11-07", "大雪": "1997-12-07" },
  "1998": { "小寒": "1998-01-05", "立春": "1998-02-04", "驚蟄": "1998-03-06", "清明": "1998-04-05", "立夏": "1998-05-05", "芒種": "1998-06-06", "小暑": "1998-07-07", "立秋": "1998-08-07", "白露": "1998-09-08", "寒露": "1998-10-08", "立冬": "1998-11-07", "大雪": "1998-12-07" },
  "1999": { "小寒": "1999-01-06", "立春": "1999-02-04", "驚蟄": "1999-03-06", "清明": "1999-04-05", "立夏": "1999-05-06", "芒種": "1999-06-06", "小暑": "1999-07-07", "立秋": "1999-08-08", "白露": "1999-09-08", "寒露": "1999-10-08", "立冬": "1999-11-08", "大雪": "1999-12-07" },
  "2000": { "小寒": "2000-01-06", "立春": "2000-02-04", "驚蟄": "2000-03-05", "清明": "2000-04-04", "立夏": "2000-05-05", "芒種": "2000-06-05", "小暑": "2000-07-07", "立秋": "2000-08-07", "白露": "2000-09-07", "寒露": "2000-10-08", "立冬": "2000-11-07", "大雪": "2000-12-07" },
  "2001": { "小寒": "2001-01-05", "立春": "2001-02-04", "驚蟄": "2001-03-05", "清明": "2001-04-05", "立夏": "2001-05-05", "芒種": "2001-06-05", "小暑": "2001-07-07", "立秋": "2001-08-07", "白露": "2001-09-07", "寒露": "2001-10-08", "立冬": "2001-11-07", "大雪": "2001-12-07" },
  "2002": { "小寒": "2002-01-05", "立春": "2002-02-04", "驚蟄": "2002-03-06", "清明": "2002-04-05", "立夏": "2002-05-05", "芒種": "2002-06-06", "小暑": "2002-07-07", "立秋": "2002-08-07", "白露": "2002-09-08", "寒露": "2002-10-08", "立冬": "2002-11-07", "大雪": "2002-12-07" },
  "2003": { "小寒": "2003-01-06", "立春": "2003-02-04", "驚蟄": "2003-03-06", "清明": "2003-04-05", "立夏": "2003-05-06", "芒種": "2003-06-06", "小暑": "2003-07-07", "立秋": "2003-08-08", "白露": "2003-09-08", "寒露": "2003-10-08", "立冬": "2003-11-08", "大雪": "2003-12-07" },
  "2004": { "小寒": "2004-01-06", "立春": "2004-02-04", "驚蟄": "2004-03-05", "清明": "2004-04-04", "立夏": "2004-05-05", "芒種": "2004-06-05", "小暑": "2004-07-07", "立秋": "2004-08-07", "白露": "2004-09-07", "寒露": "2004-10-08", "立冬": "2004-11-07", "大雪": "2004-12-07" },
  "2005": { "小寒": "2005-01-05", "立春": "2005-02-04", "驚蟄": "2005-03-05", "清明": "2005-04-05", "立夏": "2005-05-05", "芒種": "2005-06-05", "小暑": "2005-07-07", "立秋": "2005-08-07", "白露": "2005-09-07", "寒露": "2005-10-08", "立冬": "2005-11-07", "大雪": "2005-12-07" },
  "2006": { "小寒": "2006-01-05", "立春": "2006-02-04", "驚蟄": "2006-03-06", "清明": "2006-04-05", "立夏": "2006-05-05", "芒種": "2006-06-06", "小暑": "2006-07-07", "立秋": "2006-08-07", "白露": "2006-09-08", "寒露": "2006-10-08", "立冬": "2006-11-07", "大雪": "2006-12-07" },
  "2007": { "小寒": "2007-01-06", "立春": "2007-02-04", "驚蟄": "2007-03-06", "清明": "2007-04-05", "立夏": "2007-05-06", "芒種": "2007-06-06", "小暑": "2007-07-07", "立秋": "2007-08-08", "白露": "2007-09-08", "寒露": "2007-10-08", "立冬": "2007-11-08", "大雪": "2007-12-07" },
  "2008": { "小寒": "2008-01-06", "立春": "2008-02-04", "驚蟄": "2008-03-05", "清明": "2008-04-04", "立夏": "2008-05-05", "芒種": "2008-06-05", "小暑": "2008-07-07", "立秋": "2008-08-07", "白露": "2008-09-07", "寒露": "2008-10-08", "立冬": "2008-11-07", "大雪": "2008-12-07" },
  "2009": { "小寒": "2009-01-05", "立春": "2009-02-04", "驚蟄": "2009-03-05", "清明": "2009-04-04", "立夏": "2009-05-05", "芒種": "2009-06-05", "小暑": "2009-07-07", "立秋": "2009-08-07", "白露": "2009-09-07", "寒露": "2009-10-08", "立冬": "2009-11-07", "大雪": "2009-12-07" },
  "2010": { "小寒": "2010-01-05", "立春": "2010-02-04", "驚蟄": "2010-03-06", "清明": "2010-04-05", "立夏": "2010-05-05", "芒種": "2010-06-06", "小暑": "2010-07-07", "立秋": "2010-08-07", "白露": "2010-09-08", "寒露": "2010-10-08", "立冬": "2010-11-07", "大雪": "2010-12-07" },
  // 2011-2030 推算資料
  "2011": { "小寒": "2011-01-06", "立春": "2011-02-04", "驚蟄": "2011-03-06", "清明": "2011-04-05", "立夏": "2011-05-06", "芒種": "2011-06-06", "小暑": "2011-07-07", "立秋": "2011-08-08", "白露": "2011-09-08", "寒露": "2011-10-08", "立冬": "2011-11-08", "大雪": "2011-12-07" },
  "2012": { "小寒": "2012-01-06", "立春": "2012-02-04", "驚蟄": "2012-03-05", "清明": "2012-04-04", "立夏": "2012-05-05", "芒種": "2012-06-05", "小暑": "2012-07-07", "立秋": "2012-08-07", "白露": "2012-09-07", "寒露": "2012-10-08", "立冬": "2012-11-07", "大雪": "2012-12-07" },
  "2013": { "小寒": "2013-01-05", "立春": "2013-02-04", "驚蟄": "2013-03-05", "清明": "2013-04-04", "立夏": "2013-05-05", "芒種": "2013-06-05", "小暑": "2013-07-07", "立秋": "2013-08-07", "白露": "2013-09-07", "寒露": "2013-10-08", "立冬": "2013-11-07", "大雪": "2013-12-07" },
  "2014": { "小寒": "2014-01-05", "立春": "2014-02-04", "驚蟄": "2014-03-06", "清明": "2014-04-05", "立夏": "2014-05-05", "芒種": "2014-06-06", "小暑": "2014-07-07", "立秋": "2014-08-07", "白露": "2014-09-08", "寒露": "2014-10-08", "立冬": "2014-11-07", "大雪": "2014-12-07" },
  "2015": { "小寒": "2015-01-06", "立春": "2015-02-04", "驚蟄": "2015-03-06", "清明": "2015-04-05", "立夏": "2015-05-06", "芒種": "2015-06-06", "小暑": "2015-07-07", "立秋": "2015-08-08", "白露": "2015-09-08", "寒露": "2015-10-08", "立冬": "2015-11-08", "大雪": "2015-12-07" },
  "2016": { "小寒": "2016-01-06", "立春": "2016-02-04", "驚蟄": "2016-03-05", "清明": "2016-04-04", "立夏": "2016-05-05", "芒種": "2016-06-05", "小暑": "2016-07-07", "立秋": "2016-08-07", "白露": "2016-09-07", "寒露": "2016-10-08", "立冬": "2016-11-07", "大雪": "2016-12-07" },
  "2017": { "小寒": "2017-01-05", "立春": "2017-02-03", "驚蟄": "2017-03-05", "清明": "2017-04-04", "立夏": "2017-05-05", "芒種": "2017-06-05", "小暑": "2017-07-07", "立秋": "2017-08-07", "白露": "2017-09-07", "寒露": "2017-10-08", "立冬": "2017-11-07", "大雪": "2017-12-07" },
  "2018": { "小寒": "2018-01-05", "立春": "2018-02-04", "驚蟄": "2018-03-05", "清明": "2018-04-05", "立夏": "2018-05-05", "芒種": "2018-06-06", "小暑": "2018-07-07", "立秋": "2018-08-07", "白露": "2018-09-08", "寒露": "2018-10-08", "立冬": "2018-11-07", "大雪": "2018-12-07" },
  "2019": { "小寒": "2019-01-05", "立春": "2019-02-04", "驚蟄": "2019-03-06", "清明": "2019-04-05", "立夏": "2019-05-06", "芒種": "2019-06-06", "小暑": "2019-07-07", "立秋": "2019-08-08", "白露": "2019-09-08", "寒露": "2019-10-08", "立冬": "2019-11-08", "大雪": "2019-12-07" },
  "2020": { "小寒": "2020-01-06", "立春": "2020-02-04", "驚蟄": "2020-03-05", "清明": "2020-04-04", "立夏": "2020-05-05", "芒種": "2020-06-05", "小暑": "2020-07-06", "立秋": "2020-08-07", "白露": "2020-09-07", "寒露": "2020-10-08", "立冬": "2020-11-07", "大雪": "2020-12-07" },
  "2021": { "小寒": "2021-01-05", "立春": "2021-02-03", "驚蟄": "2021-03-05", "清明": "2021-04-04", "立夏": "2021-05-05", "芒種": "2021-06-05", "小暑": "2021-07-07", "立秋": "2021-08-07", "白露": "2021-09-07", "寒露": "2021-10-08", "立冬": "2021-11-07", "大雪": "2021-12-07" },
  "2022": { "小寒": "2022-01-05", "立春": "2022-02-04", "驚蟄": "2022-03-05", "清明": "2022-04-05", "立夏": "2022-05-05", "芒種": "2022-06-06", "小暑": "2022-07-07", "立秋": "2022-08-07", "白露": "2022-09-07", "寒露": "2022-10-08", "立冬": "2022-11-07", "大雪": "2022-12-07" },
  "2023": { "小寒": "2023-01-05", "立春": "2023-02-04", "驚蟄": "2023-03-06", "清明": "2023-04-05", "立夏": "2023-05-06", "芒種": "2023-06-06", "小暑": "2023-07-07", "立秋": "2023-08-08", "白露": "2023-09-08", "寒露": "2023-10-08", "立冬": "2023-11-08", "大雪": "2023-12-07" },
  "2024": { "小寒": "2024-01-06", "立春": "2024-02-04", "驚蟄": "2024-03-05", "清明": "2024-04-04", "立夏": "2024-05-05", "芒種": "2024-06-05", "小暑": "2024-07-06", "立秋": "2024-08-07", "白露": "2024-09-07", "寒露": "2024-10-08", "立冬": "2024-11-07", "大雪": "2024-12-06" },
  "2025": { "小寒": "2025-01-05", "立春": "2025-02-03", "驚蟄": "2025-03-05", "清明": "2025-04-04", "立夏": "2025-05-05", "芒種": "2025-06-05", "小暑": "2025-07-07", "立秋": "2025-08-07", "白露": "2025-09-07", "寒露": "2025-10-08", "立冬": "2025-11-07", "大雪": "2025-12-07" },
  "2026": { "小寒": "2026-01-05", "立春": "2026-02-04", "驚蟄": "2026-03-05", "清明": "2026-04-05", "立夏": "2026-05-05", "芒種": "2026-06-06", "小暑": "2026-07-07", "立秋": "2026-08-07", "白露": "2026-09-08", "寒露": "2026-10-08", "立冬": "2026-11-07", "大雪": "2026-12-07" },
  "2027": { "小寒": "2027-01-05", "立春": "2027-02-04", "驚蟄": "2027-03-06", "清明": "2027-04-05", "立夏": "2027-05-06", "芒種": "2027-06-06", "小暑": "2027-07-07", "立秋": "2027-08-08", "白露": "2027-09-08", "寒露": "2027-10-08", "立冬": "2027-11-08", "大雪": "2027-12-07" },
  "2028": { "小寒": "2028-01-06", "立春": "2028-02-04", "驚蟄": "2028-03-05", "清明": "2028-04-04", "立夏": "2028-05-05", "芒種": "2028-06-05", "小暑": "2028-07-06", "立秋": "2028-08-07", "白露": "2028-09-07", "寒露": "2028-10-08", "立冬": "2028-11-07", "大雪": "2028-12-06" },
  "2029": { "小寒": "2029-01-05", "立春": "2029-02-03", "驚蟄": "2029-03-05", "清明": "2029-04-04", "立夏": "2029-05-05", "芒種": "2029-06-05", "小暑": "2029-07-07", "立秋": "2029-08-07", "白露": "2029-09-07", "寒露": "2029-10-08", "立冬": "2029-11-07", "大雪": "2029-12-07" },
  "2030": { "小寒": "2030-01-05", "立春": "2030-02-04", "驚蟄": "2030-03-05", "清明": "2030-04-05", "立夏": "2030-05-05", "芒種": "2030-06-06", "小暑": "2030-07-07", "立秋": "2030-08-07", "白露": "2030-09-08", "寒露": "2030-10-08", "立冬": "2030-11-07", "大雪": "2030-12-07" }
};

// 精確節氣時間（UTC格式，用於邊界精確判斷）
// 來源：香港天文台實測資料
const PRECISE_SOLAR_TERMS: Record<string, Record<string, string>> = {
  "1984": {
    "立春": "1984-02-04T14:20:00Z", "驚蟄": "1984-03-05T16:59:00Z", "清明": "1984-04-04T22:45:00Z",
    "立夏": "1984-05-05T14:19:00Z", "芒種": "1984-06-05T18:21:00Z", "小暑": "1984-07-07T05:26:00Z",
    "立秋": "1984-08-07T09:09:00Z", "白露": "1984-09-07T16:15:00Z", "寒露": "1984-10-08T05:55:00Z",
    "立冬": "1984-11-07T13:17:00Z", "大雪": "1984-12-07T06:24:00Z", "小寒": "1985-01-05T16:51:00Z"
  },
  "1985": {
    "立春": "1985-02-03T21:30:00Z", "驚蟄": "1985-03-05T22:46:00Z", "清明": "1985-04-05T04:32:00Z",
    "立夏": "1985-05-05T20:04:00Z", "芒種": "1985-06-06T00:07:00Z", "小暑": "1985-07-07T11:09:00Z",
    "立秋": "1985-08-07T14:54:00Z", "白露": "1985-09-07T22:00:00Z", "寒露": "1985-10-08T11:35:00Z",
    "立冬": "1985-11-07T19:00:00Z", "大雪": "1985-12-07T12:11:00Z", "小寒": "1986-01-05T22:39:00Z"
  },
  "1989": {
    "大雪": "1989-12-07T03:20:57Z", "小寒": "1990-01-05T14:33:16Z"
  },
  "1990": {
    "立春": "1990-02-04T02:14:01Z", "驚蟄": "1990-03-05T20:19:19Z", "清明": "1990-04-05T01:12:56Z",
    "立夏": "1990-05-05T18:35:26Z", "芒種": "1990-06-05T22:46:17Z", "小暑": "1990-07-07T09:00:28Z",
    "立秋": "1990-08-07T18:45:33Z", "白露": "1990-09-07T21:37:29Z", "寒露": "1990-10-08T13:13:48Z",
    "立冬": "1990-11-07T16:23:29Z", "大雪": "1990-12-07T09:14:10Z", "小寒": "1991-01-05T20:28:08Z"
  },
  "1994": {
    "立春": "1994-02-04T03:31:00Z", "驚蟄": "1994-03-06T01:38:00Z", "清明": "1994-04-05T08:11:00Z",
    "立夏": "1994-05-06T01:36:00Z", "芒種": "1994-06-06T06:26:00Z", "小暑": "1994-07-07T17:25:00Z",
    "立秋": "1994-08-07T20:23:00Z", "白露": "1994-09-08T03:35:00Z", "寒露": "1994-10-08T23:25:00Z",
    "立冬": "1994-11-07T06:36:00Z", "大雪": "1994-12-07T00:07:00Z", "小寒": "1995-01-06T10:09:00Z"
  },
  "2000": {
    "立春": "2000-02-04T12:40:24Z", "驚蟄": "2000-03-05T06:43:43Z", "清明": "2000-04-04T13:31:58Z",
    "立夏": "2000-05-05T06:44:02Z", "芒種": "2000-06-05T10:58:38Z", "小暑": "2000-07-06T21:02:48Z",
    "立秋": "2000-08-07T06:48:39Z", "白露": "2000-09-07T09:27:07Z", "寒露": "2000-10-08T01:28:42Z",
    "立冬": "2000-11-07T04:59:35Z", "大雪": "2000-12-06T22:24:36Z", "小寒": "2001-01-05T10:15:40Z"
  }
};

// 將 HKO 簡化格式轉換為系統所需的完整格式
function convertHkoToSolarTermsData(): { years: Record<string, SolarTermsYearData> } {
  const result: { years: Record<string, SolarTermsYearData> } = { years: {} };
  
  for (const [year, terms] of Object.entries(HKO_KEY_SOLAR_TERMS)) {
    result.years[year] = {};
    for (const [termName, dateStr] of Object.entries(terms)) {
      // 優先使用精確時間（若存在）
      const preciseTime = PRECISE_SOLAR_TERMS[year]?.[termName];
      if (preciseTime) {
        result.years[year][termName] = { date: preciseTime };
      } else {
        // 回退：使用日期的開始時間 (00:00 UTC)
        result.years[year][termName] = { date: `${dateStr}T00:00:00Z` };
      }
    }
  }
  
  return result;
}

const SOLAR_TERMS_DATA = convertHkoToSolarTermsData();

type SolarTermsYears = Record<string, SolarTermsYearData>;
type SolarTermRow = { year?: number; term_name?: string; term_date?: string };

async function fetchSolarTermsData(
  supabaseClient: SupabaseClient,
  years: number[]
): Promise<SolarTermsYears> {
  const dataset: SolarTermsYears = {};
  const { data, error } = await supabaseClient
    .from('solar_terms')
    .select('year, term_name, term_date')
    .in('year', years);

  if (error || !data) {
    console.error('Solar terms fetch failed, falling back to static data', error);
    return dataset;
  }

  data.forEach((row: SolarTermRow) => {
    const { year, term_name, term_date } = row;
    if (year === undefined || year === null || !term_name?.trim() || !term_date?.trim()) return;
    const parsed = new Date(term_date);
    if (isNaN(parsed.getTime())) return;
    const yearKey = String(year);
    if (!dataset[yearKey]) {
      dataset[yearKey] = {};
    }
    dataset[yearKey][term_name] = { date: term_date };
  });

  return dataset;
}

function parseTermDate(s: string | undefined): Date | null {
  if (!s) return null;
  const fixed = s.replace(" ", "T"); // 修正極少數缺少 T 的資料
  const d = new Date(fixed);
  return isNaN(d.getTime()) ? null : d;
}

function toLocal(dateUtc: Date, tzMinutes: number): Date {
  return new Date(dateUtc.getTime() + tzMinutes * 60 * 1000);
}

function createUtcFromLocalParts(
  birth: Date,
  hour: number,
  minute: number,
  tzMinutes: number
): Date {
  return new Date(Date.UTC(
    birth.getUTCFullYear(),
    birth.getUTCMonth(),
    birth.getUTCDate(),
    hour,
    minute
  ) - tzMinutes * 60 * 1000);
}

function getMonthBranchIndexBySolarTerms(
  birthUtc: Date,
  tzMinutes: number,
  solarTermsYears: SolarTermsYears
): number | null {
  const local = toLocal(birthUtc, tzMinutes);
  const y = local.getUTCFullYear();
  // 防禦性檢查：確保節氣資料存在於對照表中
  const current = solarTermsYears[String(y)] || {};
  const prev = solarTermsYears[String(y - 1)] || {};

  const timeline: Array<{ term: string; date: Date; branchIndex: number }> = [];

  // 前一年重要節氣（覆蓋 12→1 月過渡）
  ["大雪", "小寒"].forEach((t) => {
    const d = parseTermDate(prev[t]?.date);
    if (d) {
      const branchIndex = SOLAR_TERM_BRANCH_MAP[t];
      if (branchIndex !== undefined) {
        timeline.push({ term: t, date: toLocal(d, tzMinutes), branchIndex });
      }
    }
  });

  // 本年所有節氣（含年末的大雪/小寒，資料里已跨年）
  SOLAR_TERM_BRANCH_ORDER.forEach(({ term, branchIndex }) => {
    const d = parseTermDate(current[term]?.date);
    if (d) timeline.push({ term, date: toLocal(d, tzMinutes), branchIndex });
  });

  timeline.sort((a, b) => a.date.getTime() - b.date.getTime());

  // 取小於等於出生時刻的最後一個節氣
  let chosen = timeline[0] || null;
  for (const item of timeline) {
    if (item.date.getTime() <= local.getTime()) chosen = item; else break;
  }
  return chosen ? chosen.branchIndex : null;
}

function calculateYearPillarAccurate(
  dateUtc: Date,
  tzMinutes: number,
  solarTermsYears: SolarTermsYears
): { stem: string; branch: string } {
  const local = toLocal(dateUtc, tzMinutes);
  const year = local.getUTCFullYear();
  const st = solarTermsYears[String(year)] || {};
  const lichunUtc = parseTermDate(st["立春"]?.date);
  if (!lichunUtc) {
    // 回退舊算法（約略 2/4 5:30 UTC）
    const lichunApprox = new Date(Date.UTC(year, 1, 4, 5, 30));
    return calculateYearPillar(year, lichunApprox, dateUtc);
  }
  const lichunLocal = toLocal(lichunUtc, tzMinutes);
  const adjustedYear = local < lichunLocal ? year - 1 : year;
  const stemIndex = (adjustedYear - 4) % 10;
  const branchIndex = (adjustedYear - 4) % 12;
  return {
    stem: TIANGAN[stemIndex < 0 ? stemIndex + 10 : stemIndex],
    branch: DIZHI[branchIndex < 0 ? branchIndex + 12 : branchIndex],
  };
}

// 簡單的月柱計算（不基於節氣的近似算法，僅作後備）
function calculateMonthPillarSimple(yearStem: string, month: number): { stem: string, branch: string } {
  // 月份對應地支（近似，不考慮節氣）：1月(小寒/大寒)→丑，2月→寅，3月→卯 ... 12月→子
  const branchIndexMap = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 0]; // 陣列第0項對應1月的地支索引（丑=1）
  const branchIndex = branchIndexMap[month - 1]; // 保守近似，用於缺少節氣資料時的後備計算
  
  // 五虎遁月
  const stemStartMap: { [key: string]: number } = {
    "甲": 2, "己": 2,  // 丙寅
    "乙": 4, "庚": 4,  // 戊寅
    "丙": 6, "辛": 6,  // 庚寅
    "丁": 8, "壬": 8,  // 壬寅
    "戊": 0, "癸": 0   // 甲寅
  };
  const startStem = stemStartMap[yearStem] || 0;
  const offsetFromYin = (branchIndex - 2 + 12) % 12;
  const stemIndex = (startStem + offsetFromYin) % 10;
  
  return { stem: TIANGAN[stemIndex], branch: DIZHI[branchIndex] };
}

function calculateMonthPillarAccurate(
  yearStem: string,
  birthUtc: Date,
  tzMinutes: number,
  solarTermsYears: SolarTermsYears
): { stem: string; branch: string } {
  const branchIndex = getMonthBranchIndexBySolarTerms(birthUtc, tzMinutes, solarTermsYears);
  if (branchIndex == null) {
    // 回退：若無資料，使用簡化算法
    const localMonth = toLocal(birthUtc, tzMinutes).getUTCMonth() + 1;
    return calculateMonthPillarSimple(yearStem, localMonth);
  }

  // 五虎遁月：以年干決定寅月起干
  const stemStartMap: { [key: string]: number } = {
    "甲": 2, "己": 2,  // 丙寅
    "乙": 4, "庚": 4,  // 戊寅
    "丙": 6, "辛": 6,  // 庚寅
    "丁": 8, "壬": 8,  // 壬寅
    "戊": 0, "癸": 0   // 甲寅
  };
  const startStem = stemStartMap[yearStem] || 0;
  const offsetFromYin = (branchIndex - 2 + 12) % 12; // 寅=2
  const stemIndex = (startStem + offsetFromYin) % 10;

  return { stem: TIANGAN[stemIndex], branch: DIZHI[branchIndex] };
}


// ============================================================
// 日柱計算配置（EPOCH 選擇）
// ============================================================
// 
// 【重要】兩個 EPOCH 標準存在 14 天差異，必須二選一：
//
// 選項 A - 規格書標準：1985-09-22 = 甲子
//   → 1985-10-06 = 戊寅 ✓
//   → 2000-01-01 = 戊午 ✗（萬年曆為甲辰）
//
// 選項 B - 萬年曆標準：1999-11-22 = 甲子（由 2000-01-01 = 甲辰 反推）
//   → 2000-01-01 = 甲辰 ✓
//   → 1985-10-06 = 甲子 ✗（規格書為戊寅）
//
// 當前使用：選項 A（規格書標準）
// ============================================================
// 日柱計算 v2.3.0 - 錨點校準制（Calibration-based）
// 使用 JDN 作為唯一 absDay 來源，K 常數由權威錨點決定
// ============================================================

const DAY_PILLAR_CONFIG = {
  version: "2.4.2",
  configHash: "jdn-calibration-1985-k49",
  ziHourNextDayRule: true,  // 子時（23:00-00:59）算次日
};

// 計算儒略日數（JDN）- 精確的絕對日序號公式
function calculateJDN(year: number, month: number, day: number): number {
  // 使用標準 JDN 公式（Gregorian calendar）
  // month: 1-12, day: 1-31
  const a = Math.floor((14 - month) / 12);
  const y = year + 4800 - a;
  const m = month + 12 * a - 3;
  
  // Gregorian calendar JDN
  const jdn = day + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) 
              - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
  
  return jdn;
}

// ============================================================
// 錨點校準系統
// 權威錨點：2000-01-01 = 甲辰（index 40）
// 公式：cycleIndex = (JDN + K) mod 60
// K = (anchorIndex - JDN(anchorDate) mod 60 + 60) mod 60
// ============================================================

// 生成 60 甲子表（用於驗證 index → 干支 映射）
function generateGanzhiTable(): string[] {
  const table: string[] = [];
  for (let i = 0; i < 60; i++) {
    const stem = TIANGAN[i % 10];
    const branch = DIZHI[i % 12];
    table.push(stem + branch);
  }
  return table;
}

const GANZHI_60 = generateGanzhiTable();

// 輸出 60 甲子表前 12 項用於驗證（只在啟動時輸出一次）
console.log("[60甲子表驗證] GANZHI[0..11]:", GANZHI_60.slice(0, 12).map((gz, i) => `${i}=${gz}`).join(", "));

const CALIBRATION = {
  // 權威錨點（經外部萬年曆交叉驗證 v2.4.1）
  // 1985-09-22 = 甲子 (index 0) - 多個權威來源一致確認
  anchor: { year: 1985, month: 9, day: 22, expectedIndex: 0, name: "甲子" },
  
  // 回歸驗證樣本（用於確認校準正確性，經外部權威萬年曆確認）
  regressionSamples: [
    { year: 1985, month: 10, day: 6, expectedIndex: 14, name: "戊寅" },
    { year: 2000, month: 1, day: 1, expectedIndex: 54, name: "戊午" },
    { year: 1990, month: 9, day: 27, expectedIndex: 31, name: "乙未" },
  ],
  
  // 計算 K 常數
  calculateK(): number {
    const anchorJDN = calculateJDN(this.anchor.year, this.anchor.month, this.anchor.day);
    const anchorJDNMod60 = ((anchorJDN % 60) + 60) % 60;
    const K = ((this.anchor.expectedIndex - anchorJDNMod60) % 60 + 60) % 60;
    return K;
  },
  
  // 驗證錨點
  verify(): { passed: boolean; details: string } {
    const anchorJDN = calculateJDN(this.anchor.year, this.anchor.month, this.anchor.day);
    const K = this.calculateK();
    const computedIndex = ((anchorJDN + K) % 60 + 60) % 60;
    const passed = computedIndex === this.anchor.expectedIndex;
    return {
      passed,
      details: `anchor=${this.anchor.year}-${this.anchor.month}-${this.anchor.day}, ` +
               `JDN=${anchorJDN}, K=${K}, computed=${computedIndex}, expected=${this.anchor.expectedIndex}`
    };
  },
  
  // 驗證所有回歸樣本
  verifyRegressionSamples(): { allPassed: boolean; results: Array<{ date: string; passed: boolean; computed: number; expected: number; computedName: string; expectedName: string }> } {
    const K = this.calculateK();
    const results = this.regressionSamples.map(sample => {
      const jdn = calculateJDN(sample.year, sample.month, sample.day);
      const computedIndex = ((jdn + K) % 60 + 60) % 60;
      const computedName = GANZHI_60[computedIndex];
      return {
        date: `${sample.year}-${String(sample.month).padStart(2, '0')}-${String(sample.day).padStart(2, '0')}`,
        passed: computedIndex === sample.expectedIndex,
        computed: computedIndex,
        expected: sample.expectedIndex,
        computedName,
        expectedName: sample.name
      };
    });
    return {
      allPassed: results.every(r => r.passed),
      results
    };
  },
  
  // 驗證特定日期的詳細 JDN 數據
  debugDateJDN(year: number, month: number, day: number): {
    date: string;
    jdn: number;
    rawMod60: number;
    cycleIndex: number;
    ganzhi: string;
  } {
    const jdn = calculateJDN(year, month, day);
    const rawMod60 = ((jdn % 60) + 60) % 60;
    const K = this.calculateK();
    const cycleIndex = ((jdn + K) % 60 + 60) % 60;
    return {
      date: `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
      jdn,
      rawMod60,
      cycleIndex,
      ganzhi: GANZHI_60[cycleIndex]
    };
  }
};

// 預先計算 K 常數（避免重複計算）
const CALIBRATION_K = CALIBRATION.calculateK();

// 輸出校準常數和回歸驗證結果
console.log("[校準 v2.4.1] K =", CALIBRATION_K, "錨點:", CALIBRATION.anchor.name);
console.log("[錨點驗證]", JSON.stringify(CALIBRATION.verify()));
console.log("[回歸驗證]", JSON.stringify(CALIBRATION.verifyRegressionSamples()));

function calculateDayPillar(
  birthLocal: Date, 
  hour: number, 
  timezone: string
): {
  stem: string,
  branch: string,
  debug: {
    version: string,
    configHash: string,
    timezone: string,
    useTrueSolarTime: boolean,
    ziHourNextDayRule: string,
    calibrationK: number,
    anchorVerification: string,
    regressionCheck: string,
    jdnTarget: number,
    targetDateOriginal: string,
    targetDateAdjusted: string,
    rawJDNMod60: number,
    cycleIndex: number,
    computedDayGanzhi: string,
  }
} {
  // 原始出生日期
  const originalYear = birthLocal.getUTCFullYear();
  const originalMonth = birthLocal.getUTCMonth() + 1; // 轉為 1-12
  const originalDay = birthLocal.getUTCDate();
  const originalDateStr = `${originalYear}-${String(originalMonth).padStart(2, '0')}-${String(originalDay).padStart(2, '0')}`;
  
  // 計算調整後日期（子時跨日）
  let targetYear = originalYear;
  let targetMonth = originalMonth;
  let targetDay = originalDay;
  
  // 子時（23:00-00:59）跨日規則：23:xx 和 00:xx 都視為次日
  const ziHourApplied = DAY_PILLAR_CONFIG.ziHourNextDayRule && (hour === 23 || hour === 0);
  if (ziHourApplied) {
    const tempDate = new Date(Date.UTC(originalYear, originalMonth - 1, originalDay + 1));
    targetYear = tempDate.getUTCFullYear();
    targetMonth = tempDate.getUTCMonth() + 1;
    targetDay = tempDate.getUTCDate();
  }
  
  const adjustedDateStr = `${targetYear}-${String(targetMonth).padStart(2, '0')}-${String(targetDay).padStart(2, '0')}`;
  
  // 使用 JDN + K 校準公式
  const jdnTarget = calculateJDN(targetYear, targetMonth, targetDay);
  const rawJDNMod60 = ((jdnTarget % 60) + 60) % 60;
  const cycleIndex = ((jdnTarget + CALIBRATION_K) % 60 + 60) % 60;
  
  const stemIndex = cycleIndex % 10;
  const branchIndex = cycleIndex % 12;
  const computedGanzhi = TIANGAN[stemIndex] + DIZHI[branchIndex];
  
  // 驗證資訊
  const anchorVerify = CALIBRATION.verify();
  const regressionCheck = CALIBRATION.verifyRegressionSamples();
  
  // 構建 debug 輸出
  const debug = {
    version: DAY_PILLAR_CONFIG.version,
    configHash: DAY_PILLAR_CONFIG.configHash,
    timezone: timezone,
    useTrueSolarTime: false,
    ziHourNextDayRule: ziHourApplied ? `applied (hour=${hour}, 子時跨日)` : "not applied",
    calibrationK: CALIBRATION_K,
    anchorVerification: anchorVerify.passed ? "PASS" : `FAIL: ${anchorVerify.details}`,
    regressionCheck: regressionCheck.allPassed 
      ? "ALL PASS" 
      : `SOME FAILED: ${regressionCheck.results.filter(r => !r.passed).map(r => `${r.date} computed=${r.computedName}(${r.computed}), expected=${r.expectedName}(${r.expected})`).join("; ")}`,
    jdnTarget: jdnTarget,
    targetDateOriginal: originalDateStr,
    targetDateAdjusted: adjustedDateStr,
    rawJDNMod60: rawJDNMod60,
    cycleIndex: cycleIndex,
    computedDayGanzhi: computedGanzhi,
  };
  
  console.log(`[日柱計算] Debug:`, JSON.stringify(debug, null, 2));
  
  return {
    stem: TIANGAN[stemIndex],
    branch: DIZHI[branchIndex],
    debug,
  };
}

// 計算時柱（五鼠遁時）
function calculateHourPillar(dayStem: string, hour: number): { stem: string, branch: string } {
  const stemStartMap: { [key: string]: number } = {
    "甲": 0, "己": 0,  // 甲子開始
    "乙": 2, "庚": 2,  // 丙子開始
    "丙": 4, "辛": 4,  // 戊子開始
    "丁": 6, "壬": 6,  // 庚子開始
    "戊": 8, "癸": 8   // 壬子開始
  };
  
  // 使用本地時刻的時支換算（0點為子初）
  const hourBranch = Math.floor((hour + 1) / 2) % 12;
  const startStem = stemStartMap[dayStem] || 0;
  const stemIndex = (startStem + hourBranch) % 10;
  
  return {
    stem: TIANGAN[stemIndex],
    branch: DIZHI[hourBranch]
  };
}

// 計算五行分數
function calculateWuxingScores(pillars: any): any {
  const scores: any = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
  const weightMap: any = {
    "木": "wood", "火": "fire", "土": "earth", "金": "metal", "水": "water"
  };
  
  // 天干權重較高
  [pillars.year.stem, pillars.month.stem, pillars.day.stem, pillars.hour.stem].forEach(gan => {
    const element = weightMap[WUXING_MAP[gan]];
    if (element) scores[element] += 1.5;
  });
  
  // 地支權重較低
  [pillars.year.branch, pillars.month.branch, pillars.day.branch, pillars.hour.branch].forEach(zhi => {
    const element = weightMap[WUXING_MAP[zhi]];
    if (element) scores[element] += 1.0;
  });
  
  return scores;
}

// 計算陰陽比例
function calculateYinYangRatio(pillars: any): any {
  let yin = 0;
  let yang = 0;
  
  const yangGan = ["甲", "丙", "戊", "庚", "壬"];
  const yangZhi = ["子", "寅", "辰", "午", "申", "戌"];
  
  [pillars.year, pillars.month, pillars.day, pillars.hour].forEach((pillar: any) => {
    if (yangGan.includes(pillar.stem)) yang++; else yin++;
    if (yangZhi.includes(pillar.branch)) yang++; else yin++;
  });
  
  const total = yin + yang;
  return {
    yin: Math.round((yin / total) * 100),
    yang: Math.round((yang / total) * 100)
  };
}

// 五行生剋關係
const ELEMENT_RELATIONS = {
  生: { '木': '火', '火': '土', '土': '金', '金': '水', '水': '木' },
  克: { '木': '土', '土': '水', '水': '火', '火': '金', '金': '木' }
};

// 計算天干十神
function calculateTenGodForStem(dayStem: string, targetStem: string): string {
  if (dayStem === targetStem) return '比肩';
  
  const dayElement = WUXING_MAP[dayStem];
  const targetElement = WUXING_MAP[targetStem];
  const dayYang = ["甲", "丙", "戊", "庚", "壬"].includes(dayStem);
  const targetYang = ["甲", "丙", "戊", "庚", "壬"].includes(targetStem);
  const sameYinyang = dayYang === targetYang;
  
  if (dayElement === targetElement) {
    return sameYinyang ? '比肩' : '劫財';
  }
  if (ELEMENT_RELATIONS.生[dayElement as keyof typeof ELEMENT_RELATIONS.生] === targetElement) {
    return sameYinyang ? '食神' : '傷官';
  }
  if (ELEMENT_RELATIONS.克[dayElement as keyof typeof ELEMENT_RELATIONS.克] === targetElement) {
    return sameYinyang ? '偏財' : '正財';
  }
  if (ELEMENT_RELATIONS.克[targetElement as keyof typeof ELEMENT_RELATIONS.克] === dayElement) {
    return sameYinyang ? '七殺' : '正官';
  }
  if (ELEMENT_RELATIONS.生[targetElement as keyof typeof ELEMENT_RELATIONS.生] === dayElement) {
    return sameYinyang ? '偏印' : '正印';
  }
  return '未知';
}

// 計算地支十神
function calculateTenGodForBranch(dayStem: string, branch: string): string {
  const dayElement = WUXING_MAP[dayStem];
  const branchElement = WUXING_MAP[branch];
  const dayYang = ["甲", "丙", "戊", "庚", "壬"].includes(dayStem);
  const branchYang = ["子", "寅", "辰", "午", "申", "戌"].includes(branch);
  const sameYinyang = dayYang === branchYang;
  
  if (dayElement === branchElement) {
    return sameYinyang ? '比肩' : '劫財';
  }
  if (ELEMENT_RELATIONS.生[dayElement as keyof typeof ELEMENT_RELATIONS.生] === branchElement) {
    return sameYinyang ? '食神' : '傷官';
  }
  if (ELEMENT_RELATIONS.克[dayElement as keyof typeof ELEMENT_RELATIONS.克] === branchElement) {
    return sameYinyang ? '偏財' : '正財';
  }
  if (ELEMENT_RELATIONS.克[branchElement as keyof typeof ELEMENT_RELATIONS.克] === dayElement) {
    return sameYinyang ? '七殺' : '正官';
  }
  if (ELEMENT_RELATIONS.生[branchElement as keyof typeof ELEMENT_RELATIONS.生] === dayElement) {
    return sameYinyang ? '偏印' : '正印';
  }
  return '未知';
}

// 簡化版神煞計算
function calculateShenshaSimple(
  dayStem: string,
  yearBranch: string,
  monthBranch: string,
  dayBranch: string,
  hourBranch: string
): string[] {
  const shensha: string[] = [];
  const allBranches = [yearBranch, monthBranch, dayBranch, hourBranch];
  
  // 天乙貴人查法（簡化版）
  const tianYiMap: { [key: string]: string[] } = {
    "甲": ["丑", "未"], "戊": ["丑", "未"],
    "乙": ["子", "申"], "己": ["子", "申"],
    "丙": ["亥", "酉"], "丁": ["亥", "酉"],
    "庚": ["丑", "未"], "辛": ["寅", "午"],
    "壬": ["卯", "巳"], "癸": ["卯", "巳"]
  };
  
  if (tianYiMap[dayStem] && tianYiMap[dayStem].some(b => allBranches.includes(b))) {
    shensha.push('天乙貴人');
  }
  
  // 文昌贵人查法
  const wenChangMap: { [key: string]: string[] } = {
    "甲": ["巳"], "乙": ["午"], "丙": ["申"], "丁": ["酉"],
    "戊": ["申"], "己": ["酉"], "庚": ["亥"], "辛": ["子"],
    "壬": ["寅"], "癸": ["卯"]
  };
  
  if (wenChangMap[dayStem] && wenChangMap[dayStem].some(b => allBranches.includes(b))) {
    shensha.push('文昌貴人');
  }
  
  // 桃花（咸池）查法
  const taoHuaMap: { [key: string]: string } = {
    "申": "酉", "子": "酉", "辰": "酉",
    "亥": "子", "卯": "子", "未": "子",
    "寅": "卯", "午": "卯", "戌": "卯",
    "巳": "午", "酉": "午", "丑": "午"
  };
  
  if (allBranches.includes(taoHuaMap[yearBranch])) {
    shensha.push('桃花');
  }
  
  return shensha;
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseKey = Deno.env.get('SUPABASE_ANON_KEY')!;
    const authHeader = req.headers.get('Authorization');

    // 重要：若有登入狀態，必須把 Authorization 帶入 client，否則資料庫寫入會以匿名身份執行而被 RLS 擋下
    const supabase = createClient(supabaseUrl, supabaseKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
      global: {
        headers: authHeader ? { Authorization: authHeader } : {},
      },
    });

    // 支援訪客模式：嘗試獲取用戶，但不強制要求
    let user = null;

    if (authHeader) {
      try {
        const { data: { user: authUser }, error: userError } = await supabase.auth.getUser();
        if (userError) throw userError;
        user = authUser;
      } catch (error) {
        console.log('Auth check failed, continuing as guest:', error);
      }
    }

    const { name, gender, birthDate, birthTime, location, useSolarTime, timezoneOffsetMinutes } = await req.json();

    if (!name || !gender || !birthDate || !birthTime) {
      throw new Error('Missing required fields');
    }

    // 解析出生日期和時間 - 使用UTC建立，傳入時區偏移
    const birth = new Date(birthDate);
    const [hourStr, minuteStr] = birthTime.split(':');
    const hour = parseInt(hourStr);
    const minute = parseInt(minuteStr) || 0;
    const tzOffset = timezoneOffsetMinutes || 480; // 預設UTC+8
    // birthTime 為當地時間：以 helper 轉成 UTC 時刻供後續計算
    const birthUtc = createUtcFromLocalParts(birth, hour, minute, tzOffset);
    const birthLocal = toLocal(birthUtc, tzOffset);

    // 嘗試從資料庫取得當年與前一年的節氣資料，若失敗則使用內建資料
    const targetYears = [birthLocal.getUTCFullYear(), birthLocal.getUTCFullYear() - 1];
    const dynamicSolarTerms = await fetchSolarTermsData(supabase, targetYears);
    const staticSolarTerms: SolarTermsYears = {};
    targetYears.forEach((year) => {
      const yearData = SOLAR_TERMS_DATA.years[String(year)];
      if (yearData) staticSolarTerms[String(year)] = yearData;
    });
    const solarTermsYears: SolarTermsYears = { ...staticSolarTerms };
    Object.entries(dynamicSolarTerms).forEach(([year, data]) => {
      // DB values intentionally override bundled fallbacks when present
      solarTermsYears[year] = { ...(solarTermsYears[year] || {}), ...data };
    });
    
    // 使用精確的立春時間（來自資料集）；保留近似值僅作後備
    const lichunYear = birth.getUTCFullYear();
    const lichun = new Date(Date.UTC(lichunYear, 1, 4, 5, 30)); // 保留變數以維持兼容，不再用於計算

    // 初始化計算日誌
    const calculationLogs = {
      year_log: [] as string[],
      month_log: [] as string[],
      day_log: [] as string[],
      hour_log: [] as string[],
      solar_terms_log: [] as string[],
      five_elements_log: [] as string[]
    };

    // 計算四柱
    console.log('Birth UTC:', birthUtc.toISOString(), 'tzOffset:', tzOffset);
    const yearPillar = calculateYearPillarAccurate(birthUtc, tzOffset, solarTermsYears);
    calculationLogs.year_log.push(`年柱計算: ${birthLocal.getUTCFullYear()}年 → ${yearPillar.stem}${yearPillar.branch}`);
    console.log('Year Pillar:', yearPillar);
    
    const monthPillar = calculateMonthPillarAccurate(yearPillar.stem, birthUtc, tzOffset, solarTermsYears);
    calculationLogs.month_log.push(`月柱計算: 五虎遁 年干${yearPillar.stem} + 月支${monthPillar.branch} → ${monthPillar.stem}${monthPillar.branch}`);
    console.log('Month Pillar:', monthPillar);
    
    const dayPillarResult = calculateDayPillar(birthLocal, hour, "Asia/Taipei");
    const dayPillar = { stem: dayPillarResult.stem, branch: dayPillarResult.branch };
    const dayPillarDebug = dayPillarResult.debug;
    calculationLogs.day_log.push(`日柱計算: JDN ${dayPillarDebug.jdnTarget} (K=${dayPillarDebug.calibrationK}, index=${dayPillarDebug.cycleIndex}) → ${dayPillar.stem}${dayPillar.branch}`);
    calculationLogs.day_log.push(`日柱Debug: ${JSON.stringify(dayPillarDebug)}`);
    
    const hourPillar = calculateHourPillar(dayPillar.stem, hour);
    calculationLogs.hour_log.push(`時柱計算: 五鼠遁 日干${dayPillar.stem} + ${hour}時 → ${hourPillar.stem}${hourPillar.branch}`);

    const pillars = {
      year: yearPillar,
      month: monthPillar,
      day: dayPillar,
      hour: hourPillar
    };

    // 計算納音
    const nayin = {
      year: NAYIN[yearPillar.stem + yearPillar.branch] || "未知",
      month: NAYIN[monthPillar.stem + monthPillar.branch] || "未知",
      day: NAYIN[dayPillar.stem + dayPillar.branch] || "未知",
      hour: NAYIN[hourPillar.stem + hourPillar.branch] || "未知"
    };

    // 計算五行分數和陰陽比例
    const wuxingScores = calculateWuxingScores(pillars);
    const yinyangRatio = calculateYinYangRatio(pillars);
    
    // 計算十神
    const tenGods = {
      year: {
        stem: calculateTenGodForStem(dayPillar.stem, yearPillar.stem),
        branch: calculateTenGodForBranch(dayPillar.stem, yearPillar.branch)
      },
      month: {
        stem: calculateTenGodForStem(dayPillar.stem, monthPillar.stem),
        branch: calculateTenGodForBranch(dayPillar.stem, monthPillar.branch)
      },
      day: {
        stem: "日元",
        branch: calculateTenGodForBranch(dayPillar.stem, dayPillar.branch)
      },
      hour: {
        stem: calculateTenGodForStem(dayPillar.stem, hourPillar.stem),
        branch: calculateTenGodForBranch(dayPillar.stem, hourPillar.branch)
      }
    };
    
    // 計算神煞
    const shensha = calculateShenshaSimple(
      dayPillar.stem,
      yearPillar.branch,
      monthPillar.branch,
      dayPillar.branch,
      hourPillar.branch
    );

    // 僅在有登入用戶時保存到數據庫
    let calculationId = null;
    if (user) {
      const { data: calculation, error: insertError } = await supabase
        .from('bazi_calculations')
        .insert({
          user_id: user.id,
          name,
          gender,
          birth_date: birth.toISOString(),
          birth_time: birthTime,
          location: location || null,
          use_solar_time: useSolarTime !== false,
          year_stem: yearPillar.stem,
          year_branch: yearPillar.branch,
          month_stem: monthPillar.stem,
          month_branch: monthPillar.branch,
          day_stem: dayPillar.stem,
          day_branch: dayPillar.branch,
          hour_stem: hourPillar.stem,
          hour_branch: hourPillar.branch,
          year_nayin: nayin.year,
          month_nayin: nayin.month,
          day_nayin: nayin.day,
          hour_nayin: nayin.hour,
          wuxing_scores: wuxingScores,
          yinyang_ratio: yinyangRatio,
          hidden_stems: {},
          ten_gods: tenGods,
          shensha: shensha,
          legion_analysis: {},
          legion_stories: {}
        })
        .select()
        .single();

      if (insertError) {
        console.error('Database insert error:', insertError);
        // 不中斷流程，繼續返回計算結果
      } else {
        calculationId = calculation?.id;
      }
    }

    return new Response(
      JSON.stringify({
        success: true,
        calculation: {
          id: calculationId,
          pillars,
          nayin,
          wuxingScores,
          yinyangRatio,
          tenGods,
          shensha,
          calculationLogs,
          dayPillarDebug  // 新增：日柱計算詳細 debug 資訊
        },
        isGuest: !user
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200
      }
    );

  } catch (error: any) {
    console.error('Error in calculate-bazi function:', error);
    return new Response(
      JSON.stringify({ error: error.message }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500
      }
    );
  }
});
