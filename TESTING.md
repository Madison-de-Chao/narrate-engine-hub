# 八字排盤引擎｜日柱模組回歸測試報告 v2.4.2

## 版本資訊

| 項目 | 值 |
|------|-----|
| 版本 | v2.4.2 |
| 日柱算法 | `cycleIndex = (JDN + K) mod 60` |
| 校準常數 | K = 49 |
| 子時跨日 | 23:00–00:59 視為「次日」 |
| 甲子序列 | GANZHI[0]=甲子 … GANZHI[59]=癸亥（已驗證） |
| 錨點 | 1985-09-22 = 甲子（JDN=2446331） |

## 回歸門檻（Release Gate）

- **日柱回歸測試**：必須 12/12 通過
- **權威樣本回歸**：必須 3/3 通過
- **若任一失敗**：禁止部署；必須回溯 JDN/rawMod60/K/cycleIndex/targetDateAdjusted debug

---

## 1) 權威樣本（3/3）

| 案例 | 日期時間 | 預期 index | 預期日柱 | 實際日柱 | 結果 |
|------|----------|------------|----------|----------|------|
| A1 | 1985-10-06 | 14 | 戊寅 | 戊寅 | ✅ PASS |
| A2 | 2000-01-01 | 54 | 戊午 | 戊午 | ✅ PASS |
| A3 | 1990-09-27 | 31 | 乙未 | 乙未 | ✅ PASS |

---

## 2) 邊界測試（9/9）

| # | 類別 | 日期時間 | 預期日柱 | 實際日柱 | 結果 |
|---|------|----------|----------|----------|------|
| 1 | 立春換年 | 1984-02-04 23:00 | 己巳 | 己巳 | ✅ PASS |
| 2 | 子時跨日A | 1994-10-31 23:10 | 辛卯 | 辛卯 | ✅ PASS |
| 3 | 子時跨日B | 1994-11-01 00:40 | 辛卯 | 辛卯 | ✅ PASS |
| 4 | 戌時邊界 | 1990-05-15 19:30 | 庚辰 | 庚辰 | ✅ PASS |
| 5 | 亥時邊界 | 1990-05-15 21:10 | 庚辰 | 庚辰 | ✅ PASS |
| 6 | 寒露前 | 1994-10-08 06:00 | 丁卯 | 丁卯 | ✅ PASS |
| 7 | 寒露後 | 1994-10-09 10:00 | 戊辰 | 戊辰 | ✅ PASS |
| 8 | 小寒前 | 1990-01-05 06:00 | 庚午 | 庚午 | ✅ PASS |
| 9 | 小寒後 | 1990-01-05 23:00 | 辛未 | 辛未 | ✅ PASS |

---

## 判斷結論

- **v2.4.2 日柱模組回歸測試：12/12 PASS**
- 子時跨日、節氣邊界、跨年與時辰邊界皆符合既定口徑
- 可進入下一階段：四柱全回歸（年/月/時柱）與衍生層（十神/神煞/五行）

---

## Debug 欄位標準

每筆測試需輸出：

```
jdnTarget, rawJDNMod60, calibrationK, cycleIndex, computedDayGanzhi
targetDateOriginal, targetDateAdjusted, ziHourNextDayRule
```

---

## 保護欄（CI Guard）

在測試初始化時必須驗證：

1. `K === 49`（或 `profile === "SPEC_K49"`）
2. `GANZHI_60[0] === "甲子"` 且 `GANZHI_60.length === 60`

這會杜絕未來有人改設定或改表，造成「測試仍綠但世界線不同」的事故。

---

## Level A：四柱完整驗證

### 四柱對照表（12/12 測試案例）

所有測試案例均驗證年柱/月柱/日柱/時柱的天干地支：

| # | 案例 | 年柱 | 月柱 | 日柱 | 時柱 | 結果 |
|---|------|------|------|------|------|------|
| 1 | 1985-10-06 19:30 | 乙丑 | 乙酉 | 戊寅 | 壬戌 | ✅ |
| 2 | 2000-01-01 12:00 | 己卯 | 丙子 | 戊午 | 戊午 | ✅ |
| 3 | 1990-09-27 08:32 | 庚午 | 乙酉 | 乙未 | 庚辰 | ✅ |
| 4 | 1984-02-04 23:00 | 甲子 | 丙寅 | 己巳 | 甲子 | ✅ |
| 5 | 1994-10-31 23:10 | 甲戌 | 甲戌 | 辛卯 | 戊子 | ✅ |
| 6 | 1994-11-01 00:40 | 甲戌 | 甲戌 | 辛卯 | 戊子 | ✅ |
| 7 | 1990-05-15 19:30 | 庚午 | 辛巳 | 庚辰 | 丙戌 | ✅ |
| 8 | 1990-05-15 21:10 | 庚午 | 辛巳 | 庚辰 | 丁亥 | ✅ |
| 9 | 1994-10-08 06:00 | 甲戌 | 癸酉 | 丁卯 | 癸卯 | ✅ |
| 10 | 1994-10-09 10:00 | 甲戌 | 甲戌 | 戊辰 | 丁巳 | ✅ |
| 11 | 1990-01-05 06:00 | 己巳 | 丙子 | 庚午 | 己卯 | ✅ |
| 12 | 1990-01-05 23:00 | 己巳 | 丁丑 | 辛未 | 戊子 | ✅ |

---

## Level B：衍生層驗證

### 定義範圍與版本標記

| 項目 | 定義範圍 | 版本標記 |
|------|----------|----------|
| 納音 | 完全查表（60甲子 NAYIN map） | v1.0 |
| 五行分數 | 干 1.0、支 0.8、藏干（本氣 0.6/中氣 0.4/餘氣 0.3） | v1.0 |
| 十神 | 以日干為主，五行生剋＋陰陽判斷 | v1.0 |
| 神煞 | 傳統版 20 個 / 軍團版 34 個 | trad v1.0 / legion v1.0 |

### 納音查表驗證（4 個標準樣本）

| 案例 | 年柱納音 | 月柱納音 | 日柱納音 | 時柱納音 | 結果 |
|------|----------|----------|----------|----------|------|
| Jasper 1994-10-31 | 山頭火 | 山頭火 | 松柏木 | 澗下水 | ✅ |
| 1985-10-06 | 海中金 | 泉中水 | 城頭土 | 大海水 | ✅ |
| 2000-01-01 | 城頭土 | 澗下水 | 天上火 | 天上火 | ✅ |
| 1990-09-27 | 路旁土 | 泉中水 | 沙中金 | 白蠟金 | ✅ |

### 十神關係驗證（以日干為主）

| 案例 | 日干 | 年干十神 | 年支十神 | 月干十神 | 月支十神 | 時干十神 | 時支十神 |
|------|------|----------|----------|----------|----------|----------|----------|
| Jasper 1994-10-31 | 庚 | 偏財 | 偏印 | 偏財 | 偏印 | 正官 | 正印 |
| 1985-10-06 | 戊 | 正官 | 劫財 | 正官 | 傷官 | 偏財 | 比肩 |
| 2000-01-01 | 戊 | 劫財 | 正官 | 偏印 | 偏財 | 比肩 | 偏印 |
| 1990-09-27 | 乙 | 正官 | 傷官 | 比肩 | 七殺 | 正官 | 正財 |

### 五行分數計算規則

```
權重定義：
- 天干：1.0
- 地支：0.8  
- 藏干本氣：0.6
- 藏干中氣：0.4
- 藏干餘氣：0.3
- 月令加權：× 1.5
```

---

## Jasper PDF 報告驗證案例

### 驗證來源
- 來源：使用者上傳 PDF 報告 `Jasper_八字命盤報告_20251218.pdf`
- 出生日期：1994年10月31日 02:00（丑時）
- 性別：男

### 四柱驗證結果

| 柱位 | 預期天干 | 預期地支 | 實際天干 | 實際地支 | 結果 |
|------|----------|----------|----------|----------|------|
| 年柱 | 甲 | 戌 | 甲 | 戌 | ✅ |
| 月柱 | 甲 | 戌 | 甲 | 戌 | ✅ |
| 日柱 | 庚 | 寅 | 庚 | 寅 | ✅ |
| 時柱 | 丁 | 丑 | 丁 | 丑 | ✅ |

### 納音驗證結果

| 柱位 | 預期納音 | 實際納音 | 結果 |
|------|----------|----------|------|
| 年柱 | 山頭火 | 山頭火 | ✅ |
| 月柱 | 山頭火 | 山頭火 | ✅ |
| 日柱 | 松柏木 | 松柏木 | ✅ |
| 時柱 | 澗下水 | 澗下水 | ✅ |

---

## 版本歷史

| 版本 | 日期 | 變更 |
|------|------|------|
| v2.4.3 | 2025-12-18 | 新增 Jasper PDF 驗證案例，修正十神預期值，Level A/B 完整通過 |
| v2.4.2 | 2025-12-18 | K=49 校準穩定，子時跨日修正，12/12 回歸通過 |
